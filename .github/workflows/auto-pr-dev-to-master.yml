name: Mesclagem AutomÃ¡tica dev â†’ master

permissions:
  pull-requests: write
  contents: write
  actions: write
  
on:
  schedule:
    # Executa toda segunda-feira Ã s 13:00 (1 PM)
    - cron: "0 */3 * * *"
  workflow_dispatch:  # Permite execuÃ§Ã£o manual pelo GitHub Actions

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Debug - HorÃ¡rio de ExecuÃ§Ã£o
        run: |
            echo "ğŸ• HorÃ¡rio UTC: $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "ğŸ• HorÃ¡rio BRT (aprox): $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "ğŸ“… Dia da semana: $(date '+%A')"

      # Etapa 1: Fazer checkout do repositÃ³rio com histÃ³rico completo (necessÃ¡rio para o merge)
      - name: Fazer checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Etapa 2: Configurar informaÃ§Ãµes do Git (usado caso o merge gere um commit)
      - name: Configurar Git
        run: |
          git config --global user.name "actions"
          git config --global user.email "actions@openport.com.br"

      # Etapa 3: Autenticar com o GitHub CLI (gh)
      # Utiliza o GITHUB_TOKEN padrÃ£o fornecido pelo GitHub Actions.
      - name: Autenticar no GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # Checa diferenÃ§a entre branches
      - name: Checa diferenÃ§a entre branches
        id: diff
        run: |
          git fetch origin master dev --depth=1
          if [ -z "$(git log origin/master..origin/dev --oneline)" ]; then
            echo "âœ… Nenhuma diferenÃ§a entre dev e master. Nada para mesclar."
            echo "has_diff=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸš€ HÃ¡ mudanÃ§as novas em dev. Procedendo para a criaÃ§Ã£o do PR."
            echo "has_diff=true" >> $GITHUB_OUTPUT
          fi

      # Etapa 4: Verificar se jÃ¡ existe um PR aberto de dev â†’ master.
      # Caso nÃ£o exista, criar um novo automaticamente.
      - name: Criar Pull Request de dev para master
        if: steps.diff.outputs.has_diff == 'true'
        run: |
          # Verifica se jÃ¡ hÃ¡ um PR aberto de dev â†’ master
          if gh pr list --head dev --base master --state open --json number --jq '.[0].number' | grep -q '[0-9]'; then
            echo "âœ… JÃ¡ existe um Pull Request aberto. Pulando criaÃ§Ã£o."
          else
            echo "ğŸš€ Criando novo Pull Request de dev para master..."
            gh pr create --base master --head dev --title "Merge AutomÃ¡tico: dev â†’ master" --body "Este PR foi criado automaticamente pelo GitHub Actions."
          fi

      # Etapa 5: Mesclar automaticamente o Pull Request
      - name: Mesclar Pull Request (Squash)
        if: steps.diff.outputs.has_diff == 'true'
        run: |
          pr_number=$(gh pr list --head dev --base master --state open --json number --jq '.[0].number')

          if [ -z "$pr_number" ]; then
            echo "âš ï¸ Nenhum PR encontrado para mesclar."
            exit 0
          fi

          echo "ğŸ” Verificando se hÃ¡ alteraÃ§Ãµes em workflows..."
          changed_files=$(gh pr view "$pr_number" --json files --jq '.files[].path' | grep '^.github/workflows/' || true)

          if [ -n "$changed_files" ]; then
            echo "ğŸš« PR contÃ©m alteraÃ§Ãµes em workflows (.github/workflows/). Merge automÃ¡tico bloqueado por seguranÃ§a."
            exit 0
          fi

          echo "ğŸ”„ Mesclando PR #$pr_number com squash..."
          gh pr merge --admin "$pr_number" --squash

      - name: Resetar branch dev para master
        if: success() && steps.diff.outputs.has_diff == 'true'
        run: |
          echo "â™»ï¸ Resetando branch dev para ser igual Ã  master..."

          git fetch origin master

          git checkout dev

          git reset --hard origin/master

          git push origin dev --force
