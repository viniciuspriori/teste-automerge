name: Mesclagem Autom√°tica dev ‚Üí master

permissions:
  pull-requests: write
  contents: write

on:
  schedule:
    # Executa toda segunda-feira √†s 13:00 (1 PM)
    - cron: "40 15 * * 1"
  workflow_dispatch:  # Permite execu√ß√£o manual pelo GitHub Actions

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      # Etapa 1: Fazer checkout do reposit√≥rio com hist√≥rico completo (necess√°rio para o merge)
      - name: Fazer checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Etapa 2: Configurar informa√ß√µes do Git (usado caso o merge gere um commit)
      - name: Configurar Git
        run: |
          git config --global user.name "actions"
          git config --global user.email "actions@openport.com.br"

      # Etapa 3: Autenticar com o GitHub CLI (gh)
      # Utiliza o GITHUB_TOKEN padr√£o fornecido pelo GitHub Actions.
      - name: Autenticar no GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # Etapa 4: Verificar se j√° existe um PR aberto de dev ‚Üí master.
      # Caso n√£o exista, criar um novo automaticamente.
      - name: Criar Pull Request de dev para master
        run: |
          # Verifica se j√° h√° um PR aberto de dev ‚Üí master
          if gh pr list --head dev --base master --state open --json number --jq '.[0].number' | grep -q '[0-9]'; then
            echo "‚úÖ J√° existe um Pull Request aberto. Pulando cria√ß√£o."
          else
            echo "üöÄ Criando novo Pull Request de dev para master..."
            gh pr create --base master --head dev --title "Mesclagem Autom√°tica: dev ‚Üí master" --body "Este PR foi criado automaticamente pelo GitHub Actions."
          fi

      # Etapa 5: Mesclar automaticamente o Pull Request
      - name: Mesclar Pull Request
        run: |
          pr_number=$(gh pr list --head dev --base master --state open --json number --jq '.[0].number')
          if [ -n "$pr_number" ]; then
            echo "üîÑ Mesclando PR #$pr_number..."
            # Voc√™ pode trocar "--merge" por "--squash" ou "--rebase" se preferir outro tipo de merge
            gh pr merge "$pr_number" --merge --auto --delete-branch
          else
            echo "‚ö†Ô∏è Nenhum PR encontrado para mesclar."
          fi
