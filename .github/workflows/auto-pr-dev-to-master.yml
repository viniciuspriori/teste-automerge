name: Mesclagem Autom√°tica dev ‚Üí master

permissions:
  pull-requests: write
  contents: write
  actions: write
  
on:
  schedule:
    # Executa toda segunda-feira √†s 13:00 (1 PM)
    - cron: "*/30 * * * 1"
  workflow_dispatch:  # Permite execu√ß√£o manual pelo GitHub Actions

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Debug - Hor√°rio de Execu√ß√£o
        run: |
            echo "üïê Hor√°rio UTC: $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "üïê Hor√°rio BRT (aprox): $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "üìÖ Dia da semana: $(date '+%A')"

      # Etapa 1: Fazer checkout do reposit√≥rio com hist√≥rico completo (necess√°rio para o merge)
      - name: Fazer checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Etapa 2: Configurar informa√ß√µes do Git (usado caso o merge gere um commit)
      - name: Configurar Git
        run: |
          git config --global user.name "actions"
          git config --global user.email "actions@openport.com.br"

      # Etapa 3: Autenticar com o GitHub CLI (gh)
      # Utiliza o GITHUB_TOKEN padr√£o fornecido pelo GitHub Actions.
      - name: Autenticar no GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # Etapa 4: Verificar se j√° existe um PR aberto de dev ‚Üí master.
      # Caso n√£o exista, criar um novo automaticamente.
      - name: Criar Pull Request de dev para master
        run: |
          # Verifica se j√° h√° um PR aberto de dev ‚Üí master
          if gh pr list --head dev --base master --state open --json number --jq '.[0].number' | grep -q '[0-9]'; then
            echo "‚úÖ J√° existe um Pull Request aberto. Pulando cria√ß√£o."
          else
            echo "üöÄ Criando novo Pull Request de dev para master..."
            gh pr create --base master --head dev --title "Merge Autom√°tico: dev ‚Üí master" --body "Este PR foi criado automaticamente pelo GitHub Actions."
          fi

      # Etapa 5: Mesclar automaticamente o Pull Request
      - name: Mesclar Pull Request (Squash)
        run: |
          pr_number=$(gh pr list --head dev --base master --state open --json number --jq '.[0].number')

          if [ -z "$pr_number" ]; then
            echo "‚ö†Ô∏è Nenhum PR encontrado para mesclar."
            exit 0
          fi

          echo "üîç Verificando se h√° altera√ß√µes em workflows..."
          changed_files=$(gh pr view "$pr_number" --json files --jq '.files[].path' | grep '^.github/workflows/' || true)

          if [ -n "$changed_files" ]; then
            echo "üö´ PR cont√©m altera√ß√µes em workflows (.github/workflows/). Merge autom√°tico bloqueado por seguran√ßa."
            exit 0
          fi

          echo "üîÑ Mesclando PR #$pr_number com squash..."
          gh pr merge --admin "$pr_number" --squash

      - name: Resetar branch dev para master
        if: success()
        run: |
          echo "‚ôªÔ∏è Resetando branch dev para ser igual √† master..."

          git fetch origin master

          git checkout dev

          git reset --hard origin/master

          git push origin dev --force
